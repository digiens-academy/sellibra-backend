// Prisma Schema for Digiens PrintNest Tracking

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users table
model User {
  id                  Int      @id @default(autoincrement())
  firstName           String   @map("first_name")
  lastName            String   @map("last_name")
  email               String   @unique
  password            String?  // Nullable - users from Google Sheets can use "Forgot Password"
  phoneNumber         String?  @map("phone_number")
  etsyStoreUrl        String?  @map("etsy_store_url")
  role                    String   @default("user") // "user", "admin" or "support"
  isSuperAdmin            Boolean  @default(false) @map("is_super_admin") // Super admin cannot be deleted
  hasActiveSubscription   Boolean  @default(false) @map("has_active_subscription")
  subscriptionCheckedAt   DateTime? @map("subscription_checked_at")
  registeredAt            DateTime @default(now()) @map("registered_at")
  printNestConfirmed      Boolean  @default(false) @map("printnest_confirmed") // J sütunu (DEPO İNDİRİM TANIMLADI) ile güncellenir
  dailyTokens             Int      @default(40) @map("daily_tokens")
  lastTokenReset          DateTime @default(now()) @map("last_token_reset")
  resetToken              String?  @map("reset_token")
  resetTokenExpiry        DateTime? @map("reset_token_expiry")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")

  // Relations
  printNestSessions   PrintNestSession[]
  googleSheetsSyncLog GoogleSheetsSyncLog[]
  etsyStores          EtsyStore[]

  @@map("users")
}

// PrintNest Sessions table
model PrintNestSession {
  id                 Int       @id @default(autoincrement())
  userId             Int       @map("user_id")
  sessionId          String    @unique @map("session_id")
  iframeOpenedAt     DateTime  @default(now()) @map("iframe_opened_at")
  iframeClosedAt     DateTime? @map("iframe_closed_at")
  totalTimeSpent     Int?      @map("total_time_spent") // in seconds
  userIp             String?   @map("user_ip")
  userAgent          String?   @map("user_agent") @db.Text
  referrerPage       String?   @map("referrer_page")
  interactionsCount  Int       @default(0) @map("interactions_count")
  createdAt          DateTime  @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionId])
  @@index([iframeOpenedAt])
  @@map("printnest_sessions")
}

// Google Sheets Sync Log
model GoogleSheetsSyncLog {
  id            Int      @id @default(autoincrement())
  userId        Int?     @map("user_id")
  syncType      String   @map("sync_type") // "user_registration", "printnest_confirmation", "manual_sync"
  status        String   // "success" or "failed"
  errorMessage  String?  @map("error_message") @db.Text
  syncedAt      DateTime @default(now()) @map("synced_at")

  // Relations
  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([syncedAt])
  @@map("google_sheets_sync_log")
}

// Etsy Stores table
model EtsyStore {
  id               Int       @id @default(autoincrement())
  userId           Int       @map("user_id")
  storeUrl         String    @map("store_url") @db.Text
  storeName        String?   @map("store_name")
  
  // OAuth Fields
  shopId           String?   @map("shop_id") // Etsy shop ID
  accessToken      String?   @map("access_token") @db.Text
  refreshToken     String?   @map("refresh_token") @db.Text
  tokenExpiresAt   DateTime? @map("token_expires_at")
  scopes           String[]  @default([]) // İzin verilen yetkiler
  isConnected      Boolean   @default(false) @map("is_connected") // OAuth bağlantısı aktif mi?
  
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // Relations
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  analytics        EtsyAnalytics?
  listings         EtsyListing[]
  salesSummaries   EtsySalesSummary[]

  @@index([userId])
  @@index([shopId])
  @@map("etsy_stores")
}

// System Settings table
model SystemSettings {
  id                        Int      @id @default(autoincrement())
  settingKey                String   @unique @map("setting_key")
  settingValue              String   @map("setting_value")
  settingType               String   @map("setting_type") // "boolean", "string", "number"
  description               String?
  updatedAt                 DateTime @updatedAt @map("updated_at")
  
  @@map("system_settings")
}

// Announcements table (Bildirimler/Duyurular)
model Announcement {
  id              Int       @id @default(autoincrement())
  title           String    // Bildirim başlığı
  message         String    @db.Text // Bildirim mesajı
  type            String    @default("info") // "info", "warning", "success", "error"
  isActive        Boolean   @default(true) @map("is_active") // Yayında mı?
  startDate       DateTime  @map("start_date") // Başlama tarihi
  endDate         DateTime  @map("end_date") // Bitiş tarihi
  createdBy       Int       @map("created_by") // Oluşturan kullanıcı ID'si
  targetAudience  Json?     @map("target_audience") // Hedef kitle kuralları (null = herkese göster)
  // targetAudience örneği:
  // {
  //   "roles": ["admin", "support"],                    // Sadece admin ve support görsün
  //   "hasActiveSubscription": true,                    // Sadece premium üyeler
  //   "printNestConfirmed": false,                      // PrintNest onay bekleyenler
  //   "hasEtsyStore": false,                            // Mağaza URL'si girmeyenler
  //   "excludeRoles": ["admin"]                         // Adminler hariç herkese
  // }
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  
  @@index([isActive])
  @@index([startDate, endDate])
  @@map("announcements")
}

// Etsy Analytics Cache table
// Stores aggregated shop-level metrics for quick dashboard access
model EtsyAnalytics {
  id                  Int       @id @default(autoincrement())
  storeId             Int       @unique @map("store_id")
  shopId              String    @map("shop_id")
  
  // Sales metrics
  totalSales          Int       @default(0) @map("total_sales") // Lifetime total sales count
  totalRevenue        Decimal   @default(0) @map("total_revenue") @db.Decimal(12, 2) // Lifetime revenue in USD
  todaySales          Int       @default(0) @map("today_sales")
  todayRevenue        Decimal   @default(0) @map("today_revenue") @db.Decimal(10, 2)
  weekSales           Int       @default(0) @map("week_sales")
  weekRevenue         Decimal   @default(0) @map("week_revenue") @db.Decimal(10, 2)
  monthSales          Int       @default(0) @map("month_sales")
  monthRevenue        Decimal   @default(0) @map("month_revenue") @db.Decimal(10, 2)
  
  // Shop metrics
  totalViews          Int       @default(0) @map("total_views")
  totalFavorites      Int       @default(0) @map("total_favorites")
  activeListings      Int       @default(0) @map("active_listings")
  conversionRate      Decimal?  @map("conversion_rate") @db.Decimal(5, 2) // Percentage
  avgOrderValue       Decimal?  @map("avg_order_value") @db.Decimal(10, 2)
  
  // Sync metadata
  lastSyncAt          DateTime  @map("last_sync_at") @default(now())
  syncStatus          String    @default("success") @map("sync_status") // "success", "failed", "pending"
  syncErrorMessage    String?   @map("sync_error_message") @db.Text
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  // Relations
  store               EtsyStore @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  @@index([shopId])
  @@index([lastSyncAt])
  @@map("etsy_analytics")
}

// Etsy Listings table
// Stores individual product/listing data for detailed analysis
model EtsyListing {
  id                  Int       @id @default(autoincrement())
  storeId             Int       @map("store_id")
  listingId           String    @map("listing_id") // Etsy's listing ID
  
  // Listing details
  title               String
  description         String?   @db.Text
  price               Decimal   @map("price") @db.Decimal(10, 2)
  currencyCode        String    @default("USD") @map("currency_code")
  quantity            Int       @default(0)
  state               String    @default("active") // "active", "inactive", "draft", "sold_out"
  url                 String?   @db.Text
  
  // Performance metrics
  views               Int       @default(0)
  favorites           Int       @default(0) @map("favorites")
  numFavorers         Int       @default(0) @map("num_favorers")
  totalSales          Int       @default(0) @map("total_sales")
  totalRevenue        Decimal   @default(0) @map("total_revenue") @db.Decimal(10, 2)
  
  // Images
  mainImage           String?   @map("main_image") @db.Text
  
  // Timestamps
  listingCreatedAt    DateTime? @map("listing_created_at")
  lastFetchedAt       DateTime  @default(now()) @map("last_fetched_at")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  // Relations
  store               EtsyStore @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  @@unique([storeId, listingId])
  @@index([storeId])
  @@index([listingId])
  @@index([state])
  @@map("etsy_listings")
}

// Etsy Sales Summary table
// Aggregated sales data by time period (daily/monthly)
model EtsySalesSummary {
  id                  Int       @id @default(autoincrement())
  storeId             Int       @map("store_id")
  shopId              String    @map("shop_id")
  
  // Time period
  date                DateTime  @db.Date // Date for the period
  periodType          String    @map("period_type") // "daily", "weekly", "monthly"
  
  // Sales data
  salesCount          Int       @default(0) @map("sales_count")
  revenue             Decimal   @default(0) @map("revenue") @db.Decimal(10, 2)
  avgOrderValue       Decimal?  @map("avg_order_value") @db.Decimal(10, 2)
  
  // Top products (JSON array of {listingId, title, sales, revenue})
  topProducts         Json?     @map("top_products")
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  // Relations
  store               EtsyStore @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  @@unique([storeId, date, periodType])
  @@index([storeId])
  @@index([shopId])
  @@index([date])
  @@index([periodType])
  @@map("etsy_sales_summaries")
}

// Product Pricing table
// Default pricing for common products + user overrides
model ProductPricing {
  id                  Int       @id @default(autoincrement())
  userId              Int?      @map("user_id") // null = default pricing (for all users)
  
  // Product details
  productType         String    @map("product_type") // "Bella Canvas 3001", "Gildan 18000", etc.
  size                String?   // "S", "M", "L", "XL", etc. (null = applies to all sizes)
  baseColor           String?   @map("base_color") // "White", "Black", etc. (null = applies to all colors)
  
  // Costs (in USD)
  baseCost            Decimal   @map("base_cost") @db.Decimal(10, 2) // Blank product cost
  printCost           Decimal   @map("print_cost") @db.Decimal(10, 2) // Printing cost
  shippingCost        Decimal?  @map("shipping_cost") @db.Decimal(10, 2) // Optional shipping cost
  
  // Metadata
  isDefault           Boolean   @default(false) @map("is_default") // Is this a system default?
  notes               String?   @db.Text
  
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")
  
  @@unique([userId, productType, size, baseColor])
  @@index([userId])
  @@index([productType])
  @@index([isDefault])
  @@map("product_pricing")
}
